{% extends 'base_plataforma.html' %}
{% load static %}

{% block 'plataforma' %}
    {% if messages %}
        <br>
        {% for message in messages %}
            <div class="alert {{message.tags}}">
                {{message}}
            </div>
        {% endfor %}
    {% endif %}
    <br>
    <div class="row">
        
        <div class="col-md-3">
            {% if paciente.sexo == "Masculino"%}
                <img src="{% static 'plataforma/img/perfil2.png' %}">
            {% else %}
                <img src="{% static 'plataforma/img/perfil1.png' %}">
            {% endif %}
        </div>
        <div class="col-md-7 dados descricao">
            <h4>{{paciente.nome}}</h4>
            <h6>{{paciente.datanascimento}} </h6>
        </div>
    </div>
    <hr>
    <button type="button" class="btn btn-outline-success" data-toggle="modal" data-target="#modal">
        <strong>Adicionar Dados do Paciente</strong>
    </button>
    <!--<button class="btn btn-primary" onclick="window.location.href='{% url 'imprimir_dados_paciente' paciente.id %}'">Imprimir Dados do Paciente</button>-->
    <a href="{% url 'imprimir_dados_paciente' paciente.id %}" class="btn btn-outline-success">
       <strong>Imprimir Dados do Paciente</strong> 
    </a>
    <a href="{% url 'exames:listar_solicitacoes' paciente.id %}" class="btn btn-info">
       <strong> Gerenciar Exames Laboratoriais</strong>
    </a>

    <br>
    <br>
    <table class="table table-striped">
        <thead>
            <tr>
            <th scope="col">Data</th>
            <th scope="col">Peso</th>
            <th scope="col">Altura</th>
            <th scope="col">% gordura</th>
            <th scope="col">% músculo</th>
            </tr>
        </thead>
        <tbody>
            {% for dado in dados_paciente %}
            <tr>
                <th scope="row">{{ dado.data|date:"d/m/Y" }}</th>
                <td>{% if dado.peso %}{{ dado.peso|floatformat:2 }} Kg{% else %}-{% endif %}</td>
                <td>{% if dado.altura %}{{ dado.altura|floatformat:2 }} cm{% else %}-{% endif %}</td>
                <td>{% if dado.percentual_gordura %}{{ dado.percentual_gordura|floatformat:2 }} %{% else %}-{% endif %}</td>
                <td>{% if dado.percentual_musculo %}{{ dado.percentual_musculo|floatformat:2 }} %{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
<br>

    <div style="width: 75%;">
        <canvas id="myChart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    fetch("/grafico_peso/{{paciente.id}}/", {
        method: 'POST',
    }).then(function(result) {
        return result.json();
    }).then(function(data_paciente) {
        const data = {
            labels: data_paciente['labels'],
            datasets: [
                {
                    label: 'Peso (kg)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    data: data_paciente['peso'],
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: '% Gordura',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    data: data_paciente['percentual_gordura'],
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                },
                {
                    label: '% Músculo',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(25, 107, 9, 1)',
                    borderWidth: 2,
                    data: data_paciente['percentual_musculo'],
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        };
        
        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Evolução Corporal Completa'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Peso (kg)'
                        },
                        min: 0
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Percentual (%)'
                        },
                        min: 0,
                        max: 100,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        };
        
        const myChart = new Chart(
            document.getElementById('myChart'),
            config
        );
    }).catch(function(error) {
        console.error('Erro ao carregar dados:', error);
    });
</script>

    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'dados_paciente' paciente.id %}" method="POST">{% csrf_token %}
                        <h4 class="titulo">Dados do paciente</h4>
                        <div class="form-row">
                            <div class='col-md'>
                                <label for="validationServerUsername">Peso</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="--" name="peso" step="0.01">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend3">Kg</span>
                                    </div>
                                </div>
                            </div>
                            <div class='col-md'>
                                <label for="validationServerUsername">Altura</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="--" name="altura" step="0.01">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend3">cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="form-row">
                            <div class='col-md'>
                                <label for="validationServerUsername">Percentual de gordura</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="--" name="gordura" step="0.01">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend3">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class='col-md'>
                                <label for="validationServerUsername">Percentual de músculo</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="--" name="musculo" step="0.01">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend3">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        
                        <br>
                        <input type="submit" value="Cadastrar" class="btn btn-success">
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock%}